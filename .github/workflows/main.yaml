name: Release Workflow

on:
  push:
    branches: [main]

permissions:
  # Base permissions for all jobs. Individual jobs will override for 'write' as needed.
  contents: read
  pages: write
  id-token: write
  packages: write
  pull-requests: read # Not strictly needed at top level, but doesn't hurt

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1. Build & Deploy Job (Your existing logic)
  build:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Fetch full history is important for Changesets and deployment
          fetch-depth: 0 
      
      - uses: pnpm/action-setup@v3
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm 
      - name: Install dependencies
        run: pnpm install
      - name: Build Packages
        run: pnpm build
      
      # --- Deployment Steps ---
      - name: Build with VitePress
        run: pnpm docs:build
      - name: Setup Pages
        uses: actions/configure-pages@v4
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist
          
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # 2. Release/Publish Job (The core Changesets logic)
  release:
    name: Publish Packages
    runs-on: ubuntu-latest
    # This job should only run after the build/deploy job, but it does NOT depend on 'deploy' succeeding
    # as the Changesets PR is created even if deploy fails. It should depend on 'build'.
    needs: build
    
    # ðŸš¨ CRITICAL: Grant the necessary permissions for git operations (commit/PR creation)
    permissions:
      contents: write # Needed for the action to commit version bumps
      pull-requests: write # Needed for the action to create the Version PR
      
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: pnpm/action-setup@v3
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      
      # We must re-install dependencies here for the publish step
      # because the 'release' job does not automatically share the node_modules from 'build'.
      - name: Install Dependencies
        run: pnpm install
        
      # You must rebuild BEFORE running the publish script if your publish script relies on build artifacts.
      # If pnpm build is quick, leave it. If not, consider using a separate build artifact.
      - name: Build Packages (Required for Publish)
        run: pnpm build
        
      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          # This runs 'changeset version' if changesets exist, creates a PR, and updates the PR.
          # If the commit is a merge commit from a Version PR, it runs 'changeset publish'.
          publish: pnpm release # Your final publishing command
          version: pnpm version  # Your versioning command (optional, uses default if omitted)
          commit: "chore: version bump from changesets"
          title: "ðŸš€ Version Packages" # Title for the auto-created PR
        env:
          # Required for git operations (PR creation, push)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Required for publishing to npm
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}